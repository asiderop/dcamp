#!/usr/bin/env bash

# alias runall='./bin/run-basic -x base-r; ./bin/run-basic -x base-c; ./bin/run-basic start; sleep 5; ./bin/run-basic -x base-m'

BASEDIR=`dirname $0`/..
DCAMP=$BASEDIR/bin/dcamp
XTERM='xterm -r'

ROOT=localhost:55500
COLLECTOR=localhost:55700
METRIC=localhost:55730

USAGE="usage: `basename $0` [-x|-l] <base-r|base-c|base-m|start|stop>"

if [ $# -lt 1 ]; then
	echo $USAGE
	exit 65
fi

X=1
if [ "$1" == "-x" ]; then
	X=0
	shift
fi

L=1
if [ "$1" == "-l" ]; then
	L=0
	shift
fi

case "$1" in

	base-r)
		MODS="--debug-module dcamp.service.Configuration"
		MODS="--debug-module dcamp.service.Management --debug-module dcamp.service.Node --debug-module dcamp.role.Root"
		MODS="-d"
		LOG=$BASEDIR/debug/base-r.log
		if [ $X -eq 0 ]; then
			$XTERM -geometry 131x50+0+0 -T root -e "$DCAMP $MODS base -a $ROOT 2>&1 | tee $LOG" &
		elif [ $L -eq 0 ]; then
			$DCAMP $MODS base -a $ROOT > $LOG 2>&1 &
			echo $!
		else
			$DCAMP $MODS base -a $ROOT
		fi
		;;

	base-c)
		MODS="--debug-module dcamp.service.Configuration"
		MODS="-d"
		LOG=$BASEDIR/debug/base-c.log
		if [ $X -eq 0 ]; then
			$XTERM -geometry 131x50+0+350 -T collector -e "$DCAMP $MODS base -a $COLLECTOR 2>&1 | tee $LOG" &
		elif [ $L -eq 0 ]; then
			$DCAMP $MODS base -a $COLLECTOR > $LOG 2>&1 &
			echo $!
		else
			$DCAMP $MODS base -a $COLLECTOR
		fi
		;;

	base-m)
		MODS="--debug-module dcamp.service.Node --debug-module dcamp.service.Configuration"
		MODS="--debug-module dcamp.service.Node"
		MODS="-d"
		LOG=$BASEDIR/debug/base-m.log
		if [ $X -eq 0 ]; then
			$XTERM -geometry 147x76-0+0 -T metric -e "$DCAMP $MODS base -a $METRIC 2>&1 | tee $LOG" &
		elif [ $L -eq 0 ]; then
			$DCAMP $MODS base -a $METRIC > $LOG 2>&1 &
			echo $!
		else
			$DCAMP $MODS base -a $METRIC
		fi
		;;

	start)
		$DCAMP -d root -f $BASEDIR/dcamp.cfg --start -a $ROOT
		;;

	stop)
		$DCAMP -d root -f $BASEDIR/dcamp.cfg --stop -a $ROOT
		;;
	
	*)
		echo $USAGE
		exit 65
		;;

esac
